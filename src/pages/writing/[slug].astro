---
import { type CollectionEntry, getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Nav from '../../components/Nav.astro';
import Footer from '../../components/Footer.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import { getBacklinks } from '../../lib/backlinks';

export async function getStaticPaths() {
  const posts = await getCollection('writing');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = CollectionEntry<'writing'>;

const post = Astro.props;
const allPosts = await getCollection('writing');

const { Content, headings } = await post.render();

const tocHeadings = headings.filter((h) => h.depth >= 1 && h.depth <= 3);
const backlinks = getBacklinks(allPosts, post.slug);
const tags = post.data.tags || [];

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
}

function calculateReadTime(content: string | undefined): number {
  const wordsPerMinute = 200;
  if (!content) return 1;
  const wordCount = content.split(/\s+/).length;
  return Math.max(1, Math.ceil(wordCount / wordsPerMinute));
}

const readTime = calculateReadTime(post.body);
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <div class="min-h-screen flex flex-col">
    <Nav current="writing" />

    <main class="flex-1 pt-20 sm:pt-28 pb-16">
    <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex gap-12 justify-center lg:pl-8">
        <!-- Main Content -->
        <article class="w-full max-w-content">
          <a href="/writing" class="inline-flex items-center gap-1 font-sans text-meta text-secondary hover:text-accent mb-6 transition-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
            Back to Writing
          </a>

          <header class="mb-8 sm:mb-12">
            <!-- Metadata above title, smaller text -->
            <div class="flex flex-wrap gap-2 items-center font-sans text-sm text-secondary mb-3">
              <time class="tabular-nums">{formatDate(post.data.date)}</time>
              <span>·</span>
              <span>{readTime} min read</span>
              {post.data.author && (
                <>
                  <span>·</span>
                  <span class="font-display italic text-accent">{post.data.author}</span>
                </>
              )}
            </div>

            <h1 class="font-display text-2xl sm:text-display text-ink">
              {post.data.title}
            </h1>

            <!-- Tags -->
            {tags.length > 0 && (
              <div class="flex flex-wrap gap-2 mt-4">
                {tags.map((tag) => (
                  <span class="font-sans text-xs px-2 py-1 bg-accent/5 text-secondary rounded-sm">
                    #{tag}
                  </span>
                ))}
              </div>
            )}
          </header>

          <!-- Mobile Contents Drawer -->
          <div class="lg:hidden mb-8">
            <button
              id="mobile-contents-toggle"
              type="button"
              class="w-full flex items-center justify-between px-4 py-3 bg-card border border-card rounded-sm font-sans text-sm text-ink hover:text-accent transition-none"
              aria-expanded="false"
              aria-controls="mobile-contents-panel"
            >
              <span class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7" />
                </svg>
                Contents
              </span>
              <svg
                id="contents-chevron"
                xmlns="http://www.w3.org/2000/svg"
                class="w-4 h-4 transition-transform duration-0"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
              </svg>
            </button>

            <div
              id="mobile-contents-panel"
              class="hidden mt-2 p-4 bg-card border border-card rounded-sm"
            >
              <!-- TOC -->
              {tocHeadings.length > 0 && (
                <div class="mb-6">
                  <h3 class="font-sans text-label uppercase tracking-wider text-secondary mb-3">On This Page</h3>
                  <ul class="space-y-1">
                    {tocHeadings.map((heading) => (
                      <li class={heading.depth === 2 ? 'pl-4' : heading.depth === 3 ? 'pl-8' : ''}>
                        <a
                          href={`#${heading.slug}`}
                          class="mobile-toc-link block py-1 font-sans text-sm text-secondary hover:text-accent transition-none"
                          data-slug={heading.slug}
                        >
                          {heading.text}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              <!-- Backlinks -->
              {backlinks.length > 0 && (
                <div>
                  <h3 class="font-sans text-label uppercase tracking-wider text-secondary mb-3">Linked from</h3>
                  <ul class="space-y-2">
                    {backlinks.map((backlink) => (
                      <li>
                        <a
                          href={backlink.url}
                          class="block font-sans text-sm text-ink hover:text-accent transition-none"
                        >
                          <span class="font-medium">{backlink.title}</span>
                          <span class="block text-xs text-secondary mt-0.5">
                            {formatDate(backlink.date)}
                          </span>
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          </div>

          <div class="prose prose-lg font-charter text-ink leading-relaxed">
            <Content />
          </div>
        </article>

        <!-- Sidebar (desktop only) -->
        <aside class="hidden lg:block w-60 shrink-0 lg:ml-8 space-y-8">
          <!-- TOC -->
          {tocHeadings.length > 0 && (
            <TableOfContents headings={tocHeadings} />
          )}

          <!-- Backlinks -->
          {backlinks.length > 0 && (
            <div>
              <h3 class="font-sans text-xs uppercase tracking-wider text-secondary mb-3">Linked from</h3>
              <ul class="space-y-2">
                {backlinks.map((backlink) => (
                  <li>
                    <a
                      href={backlink.url}
                      class="block font-sans text-sm text-ink hover:text-accent transition-none"
                    >
                      <span class="font-medium">{backlink.title}</span>
                      <span class="block text-xs text-secondary mt-0.5">
                        {formatDate(backlink.date)}
                      </span>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </aside>
      </div>
    </div>
  </main>

    <Footer />
  </div>

  <script>
    // Mobile contents drawer toggle
    (function() {
      const toggle = document.getElementById('mobile-contents-toggle');
      const panel = document.getElementById('mobile-contents-panel');
      const chevron = document.getElementById('contents-chevron');

      if (!toggle || !panel || !chevron) return;

      toggle.addEventListener('click', () => {
        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        toggle.setAttribute('aria-expanded', String(!isExpanded));
        panel.classList.toggle('hidden');
        chevron.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
      });

      // Close drawer when clicking on TOC links
      const mobileTocLinks = panel.querySelectorAll('.mobile-toc-link');
      mobileTocLinks.forEach((link) => {
        link.addEventListener('click', () => {
          toggle.setAttribute('aria-expanded', 'false');
          panel.classList.add('hidden');
          chevron.style.transform = 'rotate(0deg)';
        });
      });
    })();
  </script>
</BaseLayout>
