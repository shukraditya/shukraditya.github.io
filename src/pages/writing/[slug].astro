---
import { type CollectionEntry, getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Nav from '../../components/Nav.astro';
import Footer from '../../components/Footer.astro';
import TableOfContents from '../../components/TableOfContents.astro';

export async function getStaticPaths() {
  const posts = await getCollection('writing');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = CollectionEntry<'writing'>;

const post = Astro.props;
const { Content, headings } = await post.render();

const tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
}

function calculateReadTime(content: string): number {
  const wordsPerMinute = 200;
  const wordCount = content.split(/\s+/).length;
  return Math.ceil(wordCount / wordsPerMinute);
}

const readTime = calculateReadTime(post.body);
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <Nav current="writing" />

  <main class="pt-24 sm:pt-32 pb-16">
    <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex gap-12">
        <!-- Main Content -->
        <article class="flex-1 max-w-content">
          <header class="mb-8 sm:mb-12">
            <a href="/writing" class="inline-flex items-center gap-1 font-sans text-meta text-secondary hover:text-accent mb-4 transition-none">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
              </svg>
              Back to Writing
            </a>
            <h1 class="font-display text-2xl sm:text-display text-ink mb-3">
              {post.data.title}
            </h1>
            <div class="flex flex-wrap gap-2 items-center font-sans text-meta text-secondary">
              <time class="tabular-nums">{formatDate(post.data.date)}</time>
              <span>·</span>
              <span>{readTime} min read</span>
              {post.data.author && (
                <>
                  <span>·</span>
                  <span class="font-display italic text-accent">{post.data.author}</span>
                </>
              )}
            </div>
          </header>

          <div class="prose prose-lg font-charter text-ink leading-relaxed">
            <Content />
          </div>

          <div class="mt-12 pt-8 border-t border-border">
            <a href="/writing" class="font-sans text-meta text-accent hover:underline">
              ← Back to all writing
            </a>
          </div>
        </article>

        <!-- TOC Sidebar (desktop only) -->
        {tocHeadings.length > 0 && (
          <aside class="hidden lg:block w-60 shrink-0">
            <TableOfContents headings={tocHeadings} />
          </aside>
        )}
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>
